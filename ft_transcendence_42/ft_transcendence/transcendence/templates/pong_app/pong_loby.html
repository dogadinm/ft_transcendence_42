{% extends "pong_app/layout.html" %}
{% load static %}
<head>
    <link type="text/css" href="{% static 'transcendence/style_other.css' %}" rel="stylesheet">
</head>
{% block body %}
{% csrf_token %}

<link type="text/css"  href="{% static 'transcendence/style.css' %}" rel="stylesheet">
<div id="roleInfo"></div>
<canvas id="gameCanvas" width="800" height="400" style="border:1px solid black;"></canvas>

<script type="text/javascript">

    let movingUp = false;
    let movingDown = false;
    const url = `ws://${window.location.host}/ws/loby/{{ room_loby }}/`;
    const chatSocket = new WebSocket(url);
    const room = {{ room_loby }}
    let username;
    let role = "spectator"; // Default role is spectator

  chatSocket.onmessage = function (e) {
    const data = JSON.parse(e.data);
    console.log(data.type)
    document.addEventListener('keydown', handleKeyDown);
    document.addEventListener('keyup', handleKeyUp);

    if (data.type === "connection") {
        username = data.username;
        role = "spectator";
        updateRoleDisplay(role);
    }

    if (data.type === "lobby_state") {
        updateLobbyState(data.state);
    }

    if (data.type === "timer_start") {
        startCountdown(data.countdown);
    }


    if (data.type === 'game_update') {
        drawGame(data);
        }

    if (data.type === "error") {
        alert(data.message); // Display error message as an alert
    }
};

    function sendReadySignal() {
        chatSocket.send(JSON.stringify({
            action: "ready",
        }));
    }

    function assignRole(newRole) {
        chatSocket.send(JSON.stringify({
            action: "assign_role",
            role: newRole,
        }));
    }

    function updateRoleDisplay(role) {
        const roleElement = document.getElementById("role");
        roleElement.innerText = `You are: ${role}`;
    }

function updateLobbyState(state) {
    const playerList = document.getElementById("players");
    const spectatorList = document.getElementById("spectators");

    // Update players with ready status
    const left = state.left.name
        ? `${state.left.name} ${state.left.ready ? "(Ready)" : ""}`
        : "Available";
    const right = state.right.name
        ? `${state.right.name} ${state.right.ready ? "(Ready)" : ""}`
        : "Available";

    playerList.innerHTML = `
        Player 1: ${left}<br>
        Player 2: ${right}
    `;

    // Update spectators list
    spectatorList.innerHTML = state.spectators.join("<br>");
}

    function startCountdown(seconds) {
        const timerElement = document.getElementById("timer");
        timerElement.innerText = `Game starts in: ${seconds} seconds`;

        const countdown = setInterval(() => {
            seconds -= 1;
            timerElement.innerText = `Game starts in: ${seconds} seconds`;

            if (seconds <= 0) {
                clearInterval(countdown);
                timerElement.innerText = "Starting game...";
            }
        }, 1000);
    }

    function handleKeyDown(e) {
        if (e.key === 'w' && !movingUp) {
            movingUp = true;
            chatSocket.send(JSON.stringify({ action: 'move', direction: 'up' }));
        }
        if (e.key === 's' && !movingDown) {
            movingDown = true;
            chatSocket.send(JSON.stringify({ action: 'move', direction: 'down' }));
        }
    }

    function handleKeyUp(e) {
        if (e.key === 'w' && movingUp) {
            movingUp = false;
            chatSocket.send(JSON.stringify({ action: 'stop', direction: 'up' }));
        }
        if (e.key === 's' && movingDown) {
            movingDown = false;
            chatSocket.send(JSON.stringify({ action: 'stop', direction: 'down' }));
        }
    }

    function drawGame(data) {
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Draw paddles
        ctx.fillStyle = 'black';
        ctx.fillRect(10, data.paddles.left.paddleY, 10, 100); // Left paddle
        ctx.fillRect(780, data.paddles.right.paddleY, 10, 100); // Right paddle

        // Draw ball
        ctx.beginPath();
        ctx.arc(data.ball.x, data.ball.y, 10, 0, Math.PI * 2);
        ctx.fill();

        // Draw score
        ctx.font = '20px Arial';
        const leftPlayer = Object.keys(data.score)[0] || "Player 1";
        const rightPlayer = Object.keys(data.score)[1] || "Player 2";
        ctx.fillText(`${leftPlayer}: ${data.score[leftPlayer] || 0}`, 20, 20);
        ctx.fillText(`${rightPlayer}: ${data.score[rightPlayer] || 0}`, 650, 20);
    }
</script>

<h1>Lobby</h1>
<div>
    <h2 id="role"></h2>

    <h3>Players</h3>
    <div id="players"></div>
    <button onclick="assignRole('left')">Become left player </button>
    <button onclick="assignRole('right')">Become right player</button>
    <button onclick="">Leave</button>
    <button onclick="sendReadySignal()">Ready</button>

    <h3>Spectators</h3>
    <div id="spectators"></div>

    <h3 id="timer">Waiting for players...</h3>
</div>

{% endblock %}