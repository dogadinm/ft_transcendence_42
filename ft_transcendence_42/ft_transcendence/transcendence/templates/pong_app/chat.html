{% extends "pong_app/layout.html" %}

{% block body %}

<div class="chat-wrapper">
    <!-- Список друзей -->
    <div class="chat-sidebar">
        <h2>Your Friends</h2>
        <ul class="friend-list">
            {% for friend in friends %}
            <li>
                <a href="#" class="friend-item" data-friend="{{ friend.username }}">
                    {{ friend.username }}
                </a>
            </li>
            {% endfor %}
        </ul>
    </div>

    <!-- Чат -->
    <div class="chat-content">
        <h2 id="chat-header">Select a Friend</h2>

        <div id="messages" class="message-area"></div>

        <form id="message-form" class="chat-form">
            <input
                type="text"
                id="message-input"
                name="message"
                placeholder="Enter your message"
                autocomplete="off"
                required
            />
            <button type="submit">Send</button>
        </form>
    </div>
</div>

<script type="text/javascript">
    let chatSocket = null;
    let currentFriend = null;

    function openChat(friendName) {
        if (chatSocket) {
            chatSocket.close();
        }

        currentFriend = friendName;

        document.getElementById('chat-header').textContent = `Chat with: ${friendName}`;
        document.getElementById('messages').innerHTML = '';

        chatSocket = new WebSocket(`ws://${window.location.host}/ws/chat_privet/${friendName}/`);

        chatSocket.onmessage = function (e) {
            const data = JSON.parse(e.data);

            if (data.type === 'chat') {
                const messages = document.getElementById('messages');
                messages.insertAdjacentHTML(
                    'beforeend',
                    `<div><p><strong>${data.username}:</strong> ${data.message}</p></div>`
                );
                messages.scrollTop = messages.scrollHeight; // Автопрокрутка
            }
        };

        chatSocket.onclose = function () {
            console.log('Chat socket closed');
        };
    }

    // Обработка клика по другу
    const friendLinks = document.querySelectorAll('.friend-item');
    friendLinks.forEach((link) => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const friendName = link.dataset.friend;
            openChat(friendName);
        });
    });

    // Отправка сообщения
    const messageForm = document.getElementById('message-form');
    messageForm.addEventListener('submit', (e) => {
        e.preventDefault();

        const messageInput = document.getElementById('message-input').value.trim();
        if (!messageInput || !currentFriend) return;

        chatSocket.send(
            JSON.stringify({
                message: messageInput,
            })
        );

        messageForm.reset();
    });
</script>

<style>
    .chat-wrapper {
        display: flex;
        height: 100vh;
    }

    .chat-sidebar {
        flex: 0.3;
        padding: 20px;
        border-right: 1px solid #ccc;
        background-color: #f8f9fa;
    }

    .chat-content {
        flex: 0.7;
        display: flex;
        flex-direction: column;
        padding: 20px;
    }

    .friend-list {
        list-style: none;
        padding: 0;
    }

    .friend-item {
        display: block;
        margin: 10px 0;
        text-decoration: none;
        color: #007bff;
        cursor: pointer;
    }

    .friend-item:hover {
        text-decoration: underline;
    }

    .message-area {
        flex: 1;
        overflow-y: auto;
        border: 1px solid #ccc;
        border-radius: 5px;
        padding: 10px;
        margin-bottom: 10px;
        background-color: #fff;
    }

    .chat-form {
        display: flex;
        gap: 10px;
    }

    #message-input {
        flex: 1;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
    }

    button {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        background-color: #007bff;
        color: white;
        cursor: pointer;
    }

    button:hover {
        background-color: #0056b3;
    }
</style>

{% endblock %}