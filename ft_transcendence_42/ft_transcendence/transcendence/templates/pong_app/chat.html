{% extends "pong_app/layout.html" %}
{% load static %}
{% block body %}
{% block title %}Chat{% endblock %}
<head>
	<link type="text/css"  href="{% static 'transcendence/style_other.css' %}" rel="stylesheet">
</head>

<head>
	<link type="text/css"  href="{% static 'transcendence/style_other.css' %}" rel="stylesheet">
</head>

<div class="chat-sidebar">
    <h2>Your Friends</h2>
    <ul class="friend-list">
        {% for friend in friends %}
        <li>
            <a href="#" class="friend-item" data-type="private" data-name="{{ friend.username }}">
                <img src="{{ friend.photo.url }}" alt="{{ friend.username }}" class="friend-photo" />
                {{ friend.username }}
            </a>
        </li>
        {% endfor %}
    </ul>

    <h2>Your Groups</h2>
    <ul class="group-list">
        {% for group in groups %}
        <li>
            <a href="#" class="group-item" data-type="group" data-name="{{ group.name }}">
                <img src="{{ group.photo.url }}" alt="{{ group.name }}" class="friend-photo" />
                {{ group.name }}
            </a>
        </li>
        {% endfor %}
    </ul>
</div>

    <div class="chat-content">
        <div class="chat-header">
            <h2 id="chat-header">Select a Friend</h2>
            <div id="friend-info">
                <img id="friend-photo" class="friend-photo" alt="Friend's Photo" src="/media/profile_photos/profile_standard.jpg"/>
            </div>
        </div>

        <div id="messages" class="message-area"></div>

        <form id="message-form" class="chat-form">
            <input
                type="text"
                id="message-input"
                name="message"
                placeholder="Enter your message"
                autocomplete="off"
                required
            />
            <button type="submit">Send</button>
        </form>
    </div>
</div>

<script type="text/javascript">
const currentUser = "{{ current_user }}";
const profileBaseUrl = "{% url 'profile' 'username_placeholder' %}".replace('username_placeholder', '');
let chatSocket = null;
let currentChat = null;

function openChat(type, name) {
    if (chatSocket) {
        chatSocket.close();
    }

    currentChat = { type, name };

    if (type === "private") {
        document.getElementById('chat-header').innerText = `Chat with: ${name}`;
    } else if (type === "group") {
        document.getElementById('chat-header').innerText = `Group: ${name}`;
    }

    document.getElementById('messages').innerHTML = '';

    const wsPath = type === "private" 
        ? `ws://${window.location.host}/ws/chat_privet/${name}/` 
        : `ws://${window.location.host}/ws/chat_group/${name}/`;

    chatSocket = new WebSocket(wsPath);

    chatSocket.onmessage = function (e) {
        const data = JSON.parse(e.data);
        console.log(data)
        if (data.type === 'chat' || data.type === 'chat_history') {
            const messages = document.getElementById('messages');
            const messageClass = data.sender === currentUser ? 'message-right' : 'message-left';
            if (data.messages) {
                data.messages.forEach((msg) => {

                    const msgClass = msg.sender === currentUser ? 'message-right' : 'message-left';
                    messages.insertAdjacentHTML(
                        'beforeend',
                        `<div class="message ${msgClass}"><p>${msg.message}</p></div>`
                    );
                });
            } else {
                if (type === "private") {
                    messages.insertAdjacentHTML(
                    'beforeend',
                    `<div class="message ${messageClass}"><p>${data.message}</p></div>`
                );
                } else if (type === "group") {
                    messages.insertAdjacentHTML(
                    'beforeend',
                    `<div class="message ${messageClass}"><p>${data.message.message}</p></div>`
                );
                }

            }
            messages.scrollTop = messages.scrollHeight;
        }
    };

    chatSocket.onclose = function () {
        console.log('Chat socket closed');
    };
}

document.querySelectorAll('.friend-item, .group-item').forEach((link) => {
    link.addEventListener('click', (e) => {
        e.preventDefault();
        const chatType = link.dataset.type;
        const chatName = link.dataset.name;
        openChat(chatType, chatName);
    });
});

document.getElementById('message-form').addEventListener('submit', (e) => {
    e.preventDefault();
    const messageInput = document.getElementById('message-input').value.trim();

    if (!messageInput || !currentChat) return;

    chatSocket.send(JSON.stringify({ 
        action: 'massege',
        message: messageInput }));
    document.getElementById('message-form').reset();
});

</script>

<style>
    
    .chat-wrapper {
        display: flex;
        height: 100vh;
    }

    .chat-sidebar {
        flex: 0.3;
        padding: 20px;
        border-right: 1px solid #ccc;
        background-color: #f8f9fa;
    }

    .chat-content {
        flex: 0.7;
        display: flex;
        flex-direction: column;
        padding: 20px;
    }

    .friend-list {
        list-style: none;
        padding: 0;
    }

    .friend-item {
        display: flex;
        align-items: center;
        margin: 10px 0;
        text-decoration: none;
        color: #007bff;
        cursor: pointer;
    }

    .friend-item:hover {
        text-decoration: underline;
    }

    .friend-photo {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 10px;
    }

    .message-area {
        flex: 1;
        overflow-y: auto;
        border: 1px solid #ccc;
        border-radius: 5px;
        padding: 10px;
        margin-bottom: 10px;
        background-color: #fff;
    }

    .chat-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
    }

    .message {
        margin: 5px 0;
        padding: 10px;
        border-radius: 10px;
        max-width: 60%;
    }

    .message-left {
        background-color: #f1f1f1;
        align-self: flex-start;
    }

    .message-right {
        background-color: #007bff;
        color: white;
        align-self: flex-end;
    }

    .chat-form {
        display: flex;
        gap: 10px;
    }

    #message-input {
        flex: 1;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
    }

    button {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        background-color: #007bff;
        color: white;
        cursor: pointer;
    }

    button:hover {
        background-color: #0056b3;
    }
</style>

{% endblock %}
